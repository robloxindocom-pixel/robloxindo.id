<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Chat Kita</title>
  <style>
    body { font-family: sans-serif; max-width: 600px; margin: 20px auto; padding: 10px; }
    .hidden { display: none !important; }
    #admin-panel { padding: 15px; border: 1px solid #ddd; margin: 10px 0; border-radius: 8px; }
    #messages { height: 400px; border: 1px solid #ccc; padding: 10px; overflow-y: auto; margin-bottom: 10px; }
    .msg { margin: 8px 0; padding: 6px; background: #f1f1f1; border-radius: 8px; max-width: 80%; }
    .me { background: #d0f0d0; align-self: flex-end; }
    .name { font-weight: bold; font-size: 0.9em; color: #555; }
    .img { max-width: 200px; border-radius: 8px; margin-top: 5px; }
    #input-area { display: flex; gap: 5px; margin-bottom: 10px; }
    input, button { padding: 8px; }
    #clear-all-btn { background: red; color: white; border: none; }
    #logout-btn { float: right; font-size: 0.8em; }
  </style>
</head>
<body>
  <!-- Login Button (Admin) -->
  <div id="login-section">
    <h2>Chat Pribadi</h2>
    <button id="login-btn">üîê Login sebagai Admin</button>
  </div>

  <!-- Admin Panel -->
  <div id="admin-panel" class="hidden">
    <h3>Admin Panel</h3>
    <button id="logout-btn">Logout</button>
    <p><b>Email:</b> <span id="admin-email"></span></p>
    <div>
      <input type="text" id="new-key" placeholder="Kode baru" />
      <button id="update-key-btn">Ubah Kode Akses</button>
    </div>
    <button id="clear-all-btn">Hapus Semua Chat</button>
  </div>

  <!-- Chat Section (Istri) -->
  <div id="chat-section" class="hidden">
    <h3>Obrolan Kita</h3>
    <div id="messages"></div>
    <div id="input-area">
      <input type="text" id="sender" placeholder="Nama" />
      <input type="text" id="message" placeholder="Pesan..." />
      <input type="file" id="image" accept="image/*" />
      <button id="send-btn">Kirim</button>
    </div>
  </div>

  <script type="module">
    // ‚úÖ Fix: spasi di import & URL
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm'

    const supabase = createClient(
      'https://szshmnxuafjnisspzzxz.supabase.co',  // ‚úÖ Fix: no spaces
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InN6c2htbnh1YWZqbmlzc3B6enh6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU5NTM5NzAsImV4cCI6MjA3MTUyOTk3MH0.3Yiqz7KE6Q4bQAUp5aBsnrmwoiWF1IF7cborKyJ4kDA'
    )

    const ADMIN_EMAIL = 'robloxindo.com@gmail.com'

    const loginSection = document.getElementById('login-section')
    const adminPanel = document.getElementById('admin-panel')
    const chatSection = document.getElementById('chat-section')
    const adminEmailEl = document.getElementById('admin-email')
    const messagesEl = document.getElementById('messages')

    document.getElementById('login-btn').onclick = loginAdmin
    document.getElementById('logout-btn').onclick = logoutAdmin
    document.getElementById('update-key-btn').onclick = updateAccessKey
    document.getElementById('clear-all-btn').onclick = clearAllMessages
    document.getElementById('send-btn').onclick = sendMessage

    // ‚úÖ Cek session saat load
    const { data: { session } } = await supabase.auth.getSession()
    handleAuthState(session)

    // Dengarkan perubahan auth
    supabase.auth.onAuthStateChange((event, session) => {
      handleAuthState(session)
    })

    function handleAuthState(session) {
      if (session?.user?.email === ADMIN_EMAIL) {
        adminEmailEl.textContent = session.user.email
        loginSection.classList.add('hidden')
        adminPanel.classList.remove('hidden')
        chatSection.classList.remove('hidden')
        loadMessages()
        setupRealtime()
      } else {
        loginSection.classList.remove('hidden')
        adminPanel.classList.add('hidden')
        chatSection.classList.add('hidden')
        if (!document.getElementById('key-form')) {
          const form = document.createElement('div')
          form.id = 'key-form'
          form.innerHTML = `
            <h3>Masukkan Kode Akses</h3>
            <input type="password" id="access-key" placeholder="Kode" />
            <button onclick="verifyKey()">Masuk</button>
          `
          loginSection.appendChild(form)
        }
      }
    }

    // ‚úÖ Fix: redirectTo wajib ke /auth/callback
    async function loginAdmin() {
      const redirectUrl = window.location.origin + '/auth/callback'
      const { error } = await supabase.auth.signInWithOAuth({
        provider: 'google',
        options: { redirectTo: redirectUrl }
      })
      if (error) {
        console.error('Login error:', error)
        alert('Gagal login: ' + error.message)
      }
    }

    function logoutAdmin() {
      supabase.auth.signOut()
    }

    // === Verifikasi Kode (untuk istri) ===
    window.verifyKey = async function() {
      const key = document.getElementById('access-key').value.trim()
      if (!key) return alert('Isi kode')

      const { data, error } = await supabase
        .from('access_keys')
        .select('key')
        .eq('id', 1)
        .single()

      if (error || data.key !== key) {
        return alert('Kode salah!')
      }

      sessionStorage.setItem('chatKey', key)
      loginSection.classList.add('hidden')
      chatSection.classList.remove('hidden')
      loadMessages()
      setupRealtime()
    }

    // === Muat Pesan ===
    async function loadMessages() {
      const { data, error } = await supabase
        .from('messages')
        .select()
        .order('inserted_at', { ascending: true })

      if (error) return console.error(error)
      messagesEl.innerHTML = ''
      data.forEach(addMessageToUI)
    }

    function addMessageToUI(msg) {
      const div = document.createElement('div')
      div.className = 'msg'
      if (msg.sender.toLowerCase().includes('suami') || msg.sender === 'Admin') div.classList.add('me')
      div.innerHTML = `
        <div class="name">${msg.sender}</div>
        <div>${msg.content || ''}</div>
        ${msg.image_url ? `<img src="${msg.image_url}" class="img"/>` : ''}
      `
      messagesEl.appendChild(div)
      messagesEl.scrollTop = messagesEl.scrollHeight
    }

    // === Realtime ===
    function setupRealtime() {
      supabase.channel('chat')
        .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'messages' }, (payload) => {
          addMessageToUI(payload.new)
        })
        .subscribe()
    }

    // === Kirim Pesan ===
    async function sendMessage() {
      const sender = document.getElementById('sender').value.trim()
      const content = document.getElementById('message').value.trim()
      const file = document.getElementById('image').files[0]

      if (!sender) return alert('Isi nama')
      if (!content && !file) return

      let imageUrl = null
      if (file) {
        const fileName = `img_${Date.now()}_${Math.random().toString(36)}`
        const { error: uploadError } = await supabase
          .storage
          .from('chat-images')
          .upload(fileName, file)

        if (uploadError) {
          console.error('Upload error:', uploadError)
          return alert('Upload gagal')
        }

        const { data } = supabase.storage.from('chat-images').getPublicUrl(fileName)
        imageUrl = data.publicUrl
      }

      const { error } = await supabase.from('messages').insert([{ sender, content, image_url: imageUrl }])
      if (error) {
        console.error('Send error:', error)
        alert('Gagal kirim')
      } else {
        document.getElementById('message').value = ''
        document.getElementById('image').value = ''
      }
    }

    // === Admin: Ubah Kode Akses ===
    async function updateAccessKey() {
      const newKey = document.getElementById('new-key').value.trim()
      if (!newKey) return alert('Isi kode baru')

      const { error } = await supabase
        .from('access_keys')
        .update({ key: newKey })
        .eq('id', 1)

      if (error) {
        console.error('Update key error:', error)
        alert('Gagal ubah kode')
      } else {
        alert('Kode berhasil diubah!')
        document.getElementById('new-key').value = ''
      }
    }

    // === Admin: Hapus Semua Chat ===
    async function clearAllMessages() {
      if (confirm('Hapus semua chat?')) {
        const { error } = await supabase.rpc('truncate_messages')
        if (error) {
          console.error('Clear error:', error)
          alert('Gagal hapus')
        } else {
          messagesEl.innerHTML = ''
          alert('Semua chat dihapus')
        }
      }
    }
  </script>
</body>
</html>
